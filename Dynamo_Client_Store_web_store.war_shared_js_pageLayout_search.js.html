<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Dynamo/Client/Store/web/store.war/shared/js/pageLayout/search.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: Dynamo/Client/Store/web/store.war/shared/js/pageLayout/search.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * @fileoverview the search module handle the call to the search service and for updating
 * the search result details.
 */

/*global define */
define(
  //-------------------------------------------------------------------
  // PACKAGE NAME
  //-------------------------------------------------------------------
  'pageLayout/search',
  
  //-------------------------------------------------------------------
  // DEPENDENCIES
  //-------------------------------------------------------------------
  ['knockout', 'pubsub', 'ccLogger', 'viewModels/searchResultDetails', 'ccConstants', 'pageViewTracker', 'navigation', 'ccStoreConfiguration'],
    
  //-------------------------------------------------------------------
  // MODULE DEFINITION
  //-------------------------------------------------------------------
  function (ko, pubsub, log, searchResDetails, CCConstants, pageViewTracker, navigation, CCStoreConfiguration) {
    
    'use strict';
    
    /**
     * Search view model manages layout of results returned from searches. SearchViewModel is a singleton
     * class and you can access it by calling getInstance.
     * 
     * @param {Object} pAdapter
     * @param {Object} data
     * 
     * @private
     * @class
     * @name SearchViewModel
     * @property {Object} adapter Internal copy of adapter object.
     * @property {boolean} isNewSearch=true Whether this SearchViewModel is performing a new search.
     * @property {boolean} isCategorySearch=false Whether this SearchViewModel is performing a category search.
     * @property {boolean} isRequesting=false Whether there is a search request in progress.
     * @property {observable&lt;Object>} searchLocale Current locale for this search.
     * @property {CCStoreConfiguration} storeConfiguration An instance of the cc-store-configuration containing store-configuration data.
     */
    function SearchViewModel(pAdapter, data) {
      
      if(SearchViewModel.prototype.singleInstance) {
        throw new Error("Cannot instantiate more than one SearchViewModel, use SearchViewModel.getInstance(pAdapter, data)");  
      }
      
      var self = this;

      self.siteId = "Default";
      self.pagePath = "searchresults";
      self.defaultTypeaheadService = "Default/services/typeahead";
      self.popularTypeaheadSearchService = "Default/keywords/typeahead";
      self.popularTypeaheadSearchInterface = "keywords";
      self.searchPathPattern = RegExp("^.*(" + self.pagePath + ".*)$");

      self.adapter = pAdapter;
      self.isNewSearch = true;
      self.isCategorySearch = false;
      self.isRequesting = false;
      self.searchLocale = ko.observable();
      self.storeConfiguration = CCStoreConfiguration.getInstance();
      /**
       * Create a search request.
       * Set the flag getFromUrlParam to true if you want the data from the url
       * instead of providing the params.
       * 
       * @function
       * @name SearchViewModel#createSearch
       * @param {Object} otherData
       */ 
      self.createSearch = function (otherData) {
        var inputParams;
        // Set the this value to a variable and use it as required
        var current = this;
        var useEnhancedSearchEndpoint = (window.clientConfigData &amp;&amp; window.clientConfigData.useEnhancedSearch &amp;&amp; window.clientConfigData.useEnhancedSearch == "true") ? true : false;

        self.assemblerPagesPath = null;

        // Set this to the search view model in case the data is to be taken from the url params
        if (current.getFromUrlParam) {
          current = self;
        }
        // Set all the extra data sent to the current
        for (var property in this) {
          if (this.hasOwnProperty(property)) {
            current[property] = this[property];
          }
        }
        inputParams = {};
        
        /*
         * If data is sent through pubsub binding from other places, it will be present in current.
         * Put them in inputParams directly.
         */

        if (typeof current.navigationDescriptors != "undefined" &amp;&amp; current.navigationDescriptors != "") {
          inputParams[CCConstants.SEARCH_NAV_DESCRIPTORS_KEY] = current.navigationDescriptors;
        }

        if (current.suppressResults !== null &amp;&amp; current.suppressResults !== undefined) {
          inputParams[CCConstants.SEARCH_SUPPRESS_RESULTS] = current.suppressResults;
        }

        if (current.searchType) {
            inputParams[CCConstants.SEARCH_TYPE] = current.searchType;
          }

        if (current.recordOffSet !== null &amp;&amp; current.recordOffSet !== undefined) {
            inputParams[CCConstants.SEARCH_NAV_ERECS_OFFSET] = current.recordOffSet;
        }

        if (current.recordsPerPage !== null &amp;&amp; current.recordsPerPage !== undefined) {
            inputParams[CCConstants.SEARCH_REC_PER_PAGE_KEY] = current.recordsPerPage;
        }

        if (current.recSearchKey){
          inputParams[CCConstants.SEARCH_NAV_EREC_SEARCHES_KEY] = current.recSearchKey;
        }

        if (current.searchText) {
           inputParams[CCConstants.SEARCH_TERM_KEY] = current.searchText ;
         }

        if (current.searchInterface) {
          inputParams[CCConstants.SEARCH_NAV_EREC_SEARCHES_KEY] = current.searchInterface ;
        }

        if (current.sortDirectiveProperty) {
          var sortParam = current.sortDirectiveProperty;
            if( (current.sortDirectiveOrder !== undefined) &amp;&amp; (current.sortDirectiveOrder === "desc") ) {
              sortParam = sortParam + "|1";
            } else {
              sortParam = sortParam + "|0";
            }
            inputParams[CCConstants.SEARCH_SORT_ORDER] = sortParam;
        }

        if (current.recSpellCorrectionKey) {
          inputParams[CCConstants.SEARCH_DYM_SPELL_CORRECTION_KEY] = current.recSpellCorrectionKey;
        }

        if (current.rangeFilter) {
          inputParams[CCConstants.SEARCH_RANGE_FILTER] = current.rangeFilter;
        }

        if (current.recFilter) {
          inputParams[CCConstants.SEARCH_NAV_RECORD_FILTER_KEY] = current.recFilter;
        }

        //Map all the additional search query parameters to the input params
        if (current.additionalSearchQueryParams) {
          inputParams = Object.assign(inputParams, current.additionalSearchQueryParams);
        }

        var ignoreList = ["page"]; //Url properties to be ignored for the search request
        /*
         * Copy all other properties from url available in searchKeysMap in inputParams
         */
        for(var prop in current.searchKeysMap){
          if(ignoreList.indexOf(prop) &lt; 0 &amp;&amp; (inputParams[prop] == null || inputParams[prop] == undefined)){
            inputParams[prop] = current.searchKeysMap[prop];
          }
        }
        // Add additional properties in inputParams
        inputParams[CCConstants.VISITOR_ID] = pageViewTracker.getVisitorId();
        inputParams[CCConstants.VISIT_ID] = pageViewTracker.getVisitId();
        inputParams[CCConstants.SEARCH_LANGUAGE] = self.searchLocale();

        if (current.newSearch !== undefined){
          self.isNewSearch = current.newSearch;
        } else {
          self.isNewSearch = true;
        }

        // Get URL path:
        // e.g. "/Default/searchresults/all-products/_/N-123" becomes
        // "Default/searchresults/all-products/_/N-123".
        // If not matched, URL path falls back to "Default/searchresults".
        var id = self.siteId + "/" + self.pagePath;
        var rawPath = window.location.pathname;
        var matched = self.searchPathPattern.exec(rawPath);
        if (matched != null) {
          var matchedSearchPath = matched[1];
          id = self.siteId + "/" + matchedSearchPath;
        }
        if (otherData.assemblerPagesPath){
          //Replacing assemblerPagesPath in the place of "searchresults" in id
          id = id.replace(self.pagePath, otherData.assemblerPagesPath);
          self.assemblerPagesPath = otherData.assemblerPagesPath;
        } else {
          self.assemblerPagesPath = null;
        }
        if (!self.isRequesting) {
          self.isRequesting = true;

          if (current.searchText !== undefined) {
            self.isCategorySearch = false;
          } else {
            self.isCategorySearch = true;
          }
          if (useEnhancedSearchEndpoint || self.assemblerPagesPath) {
            self.adapter.loadJSON(CCConstants.ENDPOINT_SEARCH_ASSEMBLER_PAGES, id,
                inputParams, self.searchSuccess, self.searchError);
          } else {
            self.adapter.loadJSON(CCConstants.ENDPOINT_SEARCH_SEARCH, id,
                inputParams, self.searchSuccess, self.searchError);
          }
          self.matchedSearchPath = "";
        }
      };
      
      /**
       * Creates a search and adds the search data.
       * This is used when an array of data is sent from the parameters.
       * 
       * @function
       * @name SearchViewModel#createSearchAndAddData
       * @param {Object} otherData
       */
      self.createSearchAndAddData = function(otherData) {
        // Map to store search keys and their values
        self.searchKeysMap = {};

        /*
         *Parse the this.parameters from url for the keys which need default value.
         */

        // If page number is not available set default value of 1
        if (!(this.parameters.page) || (typeof parseInt(this.parameters.page) != "number")) {
          self.pageNumber = 1;
        } else{
          self.pageNumber = parseInt(this.parameters.page);
        }

        // Calculate recordOffSet with No and pageNumber, if not available, give default value
        if(this.parameters[CCConstants.SEARCH_NAV_ERECS_OFFSET] === null
            || this.parameters[CCConstants.SEARCH_NAV_ERECS_OFFSET] === undefined
              || typeof parseInt(this.parameters[CCConstants.SEARCH_NAV_ERECS_OFFSET]) != "number"){
                self.recordOffSet = 0 + (self.pageNumber - 1) * CCConstants.DEFAULT_SEARCH_RECORDS_PER_PAGE;
        }else{
          self.recordOffSet = parseInt(this.parameters[CCConstants.SEARCH_NAV_ERECS_OFFSET]) +
                                (self.pageNumber - 1) * CCConstants.DEFAULT_SEARCH_RECORDS_PER_PAGE;
        }
        self.searchKeysMap[CCConstants.SEARCH_NAV_ERECS_OFFSET] = self.recordOffSet;

        // Parse Nrpp to recordsPerPage, if not available, give default value
        if(this.parameters[CCConstants.SEARCH_REC_PER_PAGE_KEY] === null
            || this.parameters[CCConstants.SEARCH_REC_PER_PAGE_KEY] === undefined
              || typeof parseInt(this.parameters[CCConstants.SEARCH_REC_PER_PAGE_KEY]) != "number"){
                self.recordsPerPage = CCConstants.DEFAULT_SEARCH_RECORDS_PER_PAGE;
        }else{
          self.recordsPerPage = parseInt(this.parameters[CCConstants.SEARCH_REC_PER_PAGE_KEY]);
        }
        self.searchKeysMap[CCConstants.SEARCH_REC_PER_PAGE_KEY] = self.recordsPerPage;

        // Parse Ntt to searchText as it is used in other places, also to maintain backward compatibility
        if(this.parameters[CCConstants.SEARCH_TERM_KEY] !== null
            &amp;&amp; this.parameters[CCConstants.SEARCH_TERM_KEY] !== undefined){
              self.searchText = decodeURIComponent(this.parameters[CCConstants.SEARCH_TERM_KEY]);
              self.searchKeysMap[CCConstants.SEARCH_TERM_KEY] = self.searchText;
        }else{
          self.searchText = "";
        }

        // Parse Ntk to searchText as it is used in other places, also to maintain backward compatibility
        if (this.parameters[CCConstants.SEARCH_NAV_EREC_SEARCHES_KEY] !== null
              &amp;&amp; this.parameters[CCConstants.SEARCH_NAV_EREC_SEARCHES_KEY] !== undefined) {
            self.recSearchKey = decodeURIComponent(this.parameters[CCConstants.SEARCH_NAV_EREC_SEARCHES_KEY]);
            self.searchKeysMap[CCConstants.SEARCH_NAV_EREC_SEARCHES_KEY] = self.recSearchKey;
        }
        if (self.recSearchKey === undefined) {
          self.recSearchKey = "";
        }

        // Parse N to navigationDescriptors and searchKeysMap after replacing "+" with " "
        if(this.parameters[CCConstants.SEARCH_NAV_DESCRIPTORS_KEY] !== null
            &amp;&amp; this.parameters[CCConstants.SEARCH_NAV_DESCRIPTORS_KEY] !== undefined){
          self.navigationDescriptors = decodeURIComponent(this.parameters[CCConstants.SEARCH_NAV_DESCRIPTORS_KEY]).replace(/\+/g, " ");
          self.searchKeysMap[CCConstants.SEARCH_NAV_DESCRIPTORS_KEY] = self.navigationDescriptors;
        } else {
          self.navigationDescriptors = "";
        }

        /*
        *Iterate through all the properties in this.parameters from url and store them in searchKeysMap.
        *Also put the parsed values in viewmodel variables as they are used from other places too.
        */
        for(var prop in this.parameters){

          // Do not search if type is undefined or type other than "search"
          if(prop == CCConstants.PARAMETERS_TYPE){
            if(this.parameters[prop] != CCConstants.PARAMETERS_SEARCH_QUERY){
              return;
            }
          }
          // Put all other properties from url in searchKeysMap as it is.
          else{
            if(this.parameters[prop] !== null &amp;&amp; this.parameters[prop] !== undefined){
              self.searchKeysMap[prop] = decodeURIComponent(this.parameters[prop]);
            }
          }
        }
      };
      
      /**
       * Search request success callback function which publishes a pubsub event with the search results.
       * 
       * @private
       * @function
       * @name SearchViewModel#searchSuccess
       */
      self.searchSuccess = function(result){
        if(result){
        	//If search result json object contains key as "endeca:redirect"  then we will redirect to url specified in the redirect keyword configuration
        	//In this case search results page will not be shown even if there are any products available with the search term.
          if(result['endeca:redirect'] &amp;&amp; result['endeca:redirect'].link &amp;&amp; result['endeca:redirect'].link.url){
            var redirectUrl= result['endeca:redirect'].link.url;
            //If redirectUrl starts with / then it might be internal site
            if(redirectUrl.charAt(0) !== '/') {
              //It will redirect the user to a configured Redirect URL
              //In IE and Edge browsers redirect URL will be opened  in new tab and in other browsers we will open it in same tab
              if(navigator.userAgent.match(/Trident/) ||
                   navigator.userAgent.match(/Edge/)) {
                window.open(redirectUrl, '_newtab');
              } else {
                window.location.replace(redirectUrl);
              }
            }else{
              //It will redirect to the uri with the current hostname
              navigation.goTo(redirectUrl, false, true);
            }
            self.isRequesting = false;
            return;
          }
        }
        var messageDetails = [{
                                message: CCConstants.SEARCH_MESSAGE_SUCCESS,
                                requestor: self
                             }];
        
        if (result['@error']) {
          log.error("search error returned :" + result['@error']);

          messageDetails = [{message: CCConstants.SEARCH_MESSAGE_FAIL}];
        } else {
          result.assemblerPagesPath = self.assemblerPagesPath; //Adding the assemblerPagesPath to the result
          searchResDetails.update(result);
          searchResDetails.isNewSearch = self.isNewSearch;
        }
        
        // Publish 
        if (self.isCategorySearch) {
          $.Topic(pubsub.topicNames.SEARCH_RESULTS_FOR_CATEGORY_UPDATED).publishWith(searchResDetails, messageDetails);
        }
        else {
          $.Topic(pubsub.topicNames.SEARCH_RESULTS_UPDATED).publishWith( searchResDetails,messageDetails);
        }
        self.isRequesting = false;
      };
      
      /**
       * Search request failure callback function. This publishes a search failed pubsub event.
       * 
       * @private
       * @function
       * @name SearchViewModel#searchError
       */
      self.searchError = function(result){

        // Publish
        if (self.isCategorySearch) {
          $.Topic(pubsub.topicNames.SEARCH_FAILED_TO_PERFORM).publish();
        }
        else {
          var messageDetails = [{message: CCConstants.SEARCH_MESSAGE_FAIL}];
          $.Topic(pubsub.topicNames.SEARCH_RESULTS_UPDATED).publishWith(result,messageDetails);
        }
      self.isRequesting = false;
      };
      
      /**
       * Create a typeahead search request.
       * 
       * @function
       * @name SearchViewModel#typeaheadSearch
       * @param {Object} otherData
       */
      self.typeaheadSearch = function (otherData) {

        var id, inputParams;
        if (this.searchText !== undefined) {
          this.searchText = this.searchText.trim();
        }
        if(this.typeaheadConfig !== undefined &amp;&amp; this.typeaheadConfig.searchText !== undefined) {
          this.searchText = this.typeaheadConfig.searchText;
        }
        var typeaheadConfig = this.typeaheadConfig;
        var successCallBack = function(result) {
          self.successTypeahead(result, typeaheadConfig);
        }

        var visitorId = pageViewTracker.getVisitorId();
        var visitId = pageViewTracker.getVisitId();
        inputParams = {};
        inputParams[CCConstants.SEARCH_TERM_KEY] =  this.searchText;
        inputParams[CCConstants.SEARCH_NAV_EREC_SEARCHES_KEY] = CCConstants.TYPEAHEAD_SEARCH_INTERFACE;
        inputParams[CCConstants.VISITOR_ID] = visitorId;
        inputParams[CCConstants.VISIT_ID] = visitId;
        inputParams[CCConstants.SEARCH_TYPE] = CCConstants.SEARCH_TYPE_TYPEAHEAD;
        inputParams[CCConstants.SEARCH_LANGUAGE] = self.searchLocale();
        inputParams[CCConstants.ASSEMBLER_PATH_QUERY_PARAM] = CCConstants.ASSEMBLER_DEFAULT_TYPEAHEAD_PATH;
        inputParams[CCConstants.ASSEMBLER_REDIRECTS_QUERY_PARAM] = "yes";
        inputParams[CCConstants.ASSEMBLER_SITE_QUERY_PARAM] = "default";

        if(this.typeaheadConfig !== undefined &amp;&amp; this.typeaheadConfig.queryParams !== undefined ) {

          if (this.newSearch !== undefined){
            self.isNewSearch = this.newSearch;
          }

          // iterate over input map entries and add them to assembler query request.
          this.typeaheadConfig.queryParams.forEach(function(value, key) {
            inputParams[key] = value;
          });
          $.each(this.typeaheadConfig.queryParams, function(key, value) {
            inputParams[key] = value;
          });

          if(typeaheadConfig.usePopularSearch === true){
            inputParams[CCConstants.SEARCH_NAV_EREC_SEARCHES_KEY] = self.popularTypeaheadSearchInterface;
            id = self.popularTypeaheadSearchService;
            self.adapter.loadJSON(CCConstants.ENDPOINT_SEARCH_ASSEMBLER_PAGES, id, inputParams, successCallBack,  self.failureTypeahead);
          } else {
            id = typeaheadConfig.assemblerPagesPath ? typeaheadConfig.assemblerPagesPath : 'Default/services/typeahead'; //Updating the id of the call with assemblerPagesPath.
            self.adapter.loadJSON(CCConstants.ENDPOINT_SEARCH_ASSEMBLER_PAGES, id, inputParams, successCallBack,  self.failureTypeahead); //Endpoint call to new assembler pages endpoint.
          }

        } else {

          inputParams[CCConstants.SEARCH_NAV_ERECS_OFFSET] = this.recordOffSet;
          inputParams[CCConstants.SEARCH_REC_PER_PAGE_KEY] = this.recordsPerPage;


          if (this.newSearch !== undefined){
            self.isNewSearch = this.newSearch;
          }

          id = 'assembler';
          self.adapter.loadJSON('assembler', id, inputParams, self.typeaheadSuccess, self.typeaheadError);

        }

      };

      self.successTypeahead = function(result, typeaheadConfig) {

        var messageDetails = [{message: CCConstants.SEARCH_MESSAGE_SUCCESS}];
        if (result['@error']) {
          log.error("search error returned :" + result['@error']);
          messageDetails = [{message: CCConstants.SEARCH_MESSAGE_FAIL}];
        }

        if((result.resultsList) &amp;&amp; (result.resultsList.records)) {

          var productRecords = result.resultsList.records;
          for (var i = 0; i &lt; productRecords.length; i++) {
            if(!typeaheadConfig.assemblerPagesPath &amp;&amp; typeaheadConfig.usePopularSearch !== true){

            var skuRecord = productRecords[i].records[0];
            var displayRecord = {}, displayPrice;
            $.each(typeaheadConfig.displayProps, function(index, displayProp){

              if(skuRecord.attributes[displayProp]
                  &amp;&amp; skuRecord.attributes[displayProp] !== undefined) {

                displayRecord[displayProp] = skuRecord.attributes[displayProp][0];
              } else {
                displayRecord[displayProp] = '';
              }

            });

            // Map the default set of properties to response object
            // build product link. 
            // For style based products, build query params for variant name and value.
            displayRecord["product.route"] = skuRecord.attributes["product.route"][0];
            if(Array.isArray(skuRecord.attributes["sku.styleProperty"]) ) {
              $.each(skuRecord.attributes["sku.styleProperty"], function(index, styleProperty){
                  var styleValue;
                  if (Array.isArray(skuRecord.attributes["sku."+styleProperty])) {
                      styleValue = skuRecord.attributes["sku."+styleProperty][0];
                  }
                  if (styleValue) {
                    displayRecord["product.route"] = displayRecord["product.route"]
                                   + "?variantName=" + styleProperty + "&amp;variantValue=" + styleValue;
                  } 
              });
              
            }
            // calculate price to be displayed in typeahead dropdown.
            // OOTB, assembler search query would give the aggregated record
            // rolled up on 'product.id'. In such cases we would pick 'sku.minActivePrice'.
            // If not, we loop through the sku's list and find the minimum sale price among them.
            if(productRecords[i].attributes &amp;&amp; productRecords[i].attributes["sku.minActivePrice"]
                    &amp;&amp; Array.isArray(productRecords[i].attributes["sku.minActivePrice"])) {
              // use the calculated 'sku.minActivePrice'
              displayPrice = productRecords[i].attributes["sku.minActivePrice"][0];
            } else {
              // calculate the displayPrice by looping through all SKU's.
              var productSalePrice = (skuRecord.attributes["product.salePrice"]) ? skuRecord.attributes["product.salePrice"][0] : null;
              var productListPrice = (skuRecord.attributes["product.listPrice"]) ? skuRecord.attributes["product.listPrice"][0] : null;
              var productPrice = productSalePrice ? productSalePrice : productListPrice;
              var minSkuPrice;
              if(Array.isArray(productRecords[i].records) &amp;&amp; productRecords[i].records.length > 0) {
                $.each(productRecords[i].records, function (index, skuRec){
                  var skuSalePrice = (skuRec.attributes["sku.salePrice"]) ? skuRec.attributes["sku.salePrice"][0] : null;
                  var skuListPrice = (skuRec.attributes["sku.listPrice"]) ? skuRec.attributes["sku.listPrice"][0] : null;
                  var skuPrice = skuSalePrice ? skuSalePrice : skuListPrice;
                  if(!skuPrice) {
                    skuPrice = productPrice;
                  }
                  if(!minSkuPrice || (skuPrice &lt; minSkuPrice)) {
                    minSkuPrice = skuPrice;
                  }
                });
              }
              displayPrice = minSkuPrice;
            }
            displayRecord["displayPrice"] = displayPrice;
            displayRecord["product.repositoryId"] = skuRecord.attributes["product.repositoryId"][0];
            if(Array.isArray(skuRecord.attributes["product.primaryImageAltText"])) {
              displayRecord["product.primaryImageAltText"] = skuRecord.attributes["product.primaryImageAltText"][0];
            } else {
                displayRecord["product.primaryImageAltText"] = "";    
            }
            if(Array.isArray(skuRecord.attributes["product.primaryImageTitle"])) {
              displayRecord["product.primaryImageTitle"] = skuRecord.attributes["product.primaryImageTitle"][0];
            } else {
                displayRecord["product.primaryImageTitle"] = "";
            }
            typeaheadConfig.searchResults.push(displayRecord);
          } else {
            typeaheadConfig.searchResults.push(productRecords[i].attributes);
          }
          }
        }
        var result = (typeaheadConfig.getSearchResponse !== undefined &amp;&amp; typeaheadConfig.getSearchResponse) ? result : null;
        typeaheadConfig.displayCallback(typeaheadConfig, result);
      };

      self.failureTypeahead = function(result) {
        log.error("Couldn't execute typeahead search query.");
      };

      /**
       * Typeahead search request success callback function which publishes a pubsub event with the search results.
       * 
       * @private
       * @function
       * @name SearchViewModel#typeaheadSuccess
       */      
      self.typeaheadSuccess = function(result) {
        
        var messageDetails = [{message: CCConstants.SEARCH_MESSAGE_SUCCESS}];
        if (result['@error']) {
          log.error("search error returned :" + result['@error']);

          messageDetails = [{message: CCConstants.SEARCH_MESSAGE_FAIL}];
        }
        
        // don't update result model or both result lists are updated when on
        // search results page. Just pass through what's needed
        var searchResults = [];
        
        if((result.resultsList) &amp;&amp; (result.resultsList.records)) {
          var typeaheadResults = [];
          searchResults = result.resultsList.records;
          searchResDetails.update(result);
          typeaheadResults.push(searchResDetails.searchResults);
          typeaheadResults.push(searchResults);
        }
        
        $.Topic(pubsub.topicNames.SEARCH_TYPEAHEAD_UPDATED).publishWith(typeaheadResults,[{message:"success"}]);
          
      };
      
      /**
       * Typeahead search request failure callback function which publishes a pubsub failure event.
       * 
       * @private
       * @function
       * @name SearchViewModel#typeaheadError
       */   
      self.typeaheadError = function(result){
        
        var messageDetails = [{message: CCConstants.SEARCH_MESSAGE_FAIL}];
        
         var searchResults = [];
        $.Topic(pubsub.topicNames.SEARCH_TYPEAHEAD_UPDATED).publishWith(searchResults,[{message:"success"}]);
        
      };
            
      // Subscribe to the search create pubsub.topicNames.SEARCH_CREATE_CATEGORY_LISTING
      $.Topic(pubsub.topicNames.SEARCH_CREATE_CATEGORY_LISTING).subscribe(self.createSearch);
      // Subscribe to the search create pubsub.topicNames.SEARCH_CREATE
      $.Topic(pubsub.topicNames.SEARCH_CREATE).subscribe(self.createSearch);
      
      // Subscribe to the page parameters pubsub.topicNames.PAGE_PARAMETERS
      // Please note that the SEARCH_CREATE is kept intact since it is also used
      // in searchTypeAhead
      $.Topic(pubsub.topicNames.PAGE_PARAMETERS).subscribe(self.createSearchAndAddData);
      
      // Subscribe to the search create pubsub.topicNames.SEARCH_TYPEAHEAD
      $.Topic(pubsub.topicNames.SEARCH_TYPEAHEAD).subscribe(self.typeaheadSearch);
      
      return(self);
    }
    
    /**
     * setContext
     * Set the context data from the SearchDataInitializer
     *
     * @function
     * @name SearchViewModel#setContext
     * @param {Object} pContext
     */
    SearchViewModel.prototype.setContext = function(pContext) {
      var self = this;
      if (pContext.global.locale) {
        self.searchLocale(pContext.global.locale);
      }
      self.contextData = pContext;
    };
    
    /**
     * Return the singleton instance of SearchViewModel.
     *
     * @function
     * @name SearchViewModel#getInstance
     * @param {Object} pAdapter
     * @param {Object} data 
     * @param {Object} pParams Optional params object which will be used as the context for the search.
     */
    SearchViewModel.getInstance = function(pAdapter, data, pParams) {
      if(!SearchViewModel.prototype.singleInstance) {
        SearchViewModel.prototype.singleInstance = new SearchViewModel(pAdapter, data);
      }
      if (pParams) {
        SearchViewModel.prototype.singleInstance.setContext(pParams);
      }
      
      return SearchViewModel.prototype.singleInstance;
    };
    
    /**
     * Get the navigation parameters excluding the additional search params.
     * 
     * @function
     * @name SearchViewModel#getFilteredNavState
     * @returns {string} The navigation state as a URI param string.
     */
    SearchViewModel.prototype.getFilteredNavState = function(navivationString) {
      var filteredArray = [];
      var addnlSearchParams = [CCConstants.VISITOR_ID, CCConstants.VISIT_ID, CCConstants.SEARCH_LANGUAGE, CCConstants.SEARCH_TYPE];
      var params = navivationString.split("&amp;");
      for (var i = 0; i &lt; params.length; i++) {
        var tempParam = params[i].split("=");
        if (addnlSearchParams.indexOf(tempParam[0]) == -1){
          filteredArray.push(params[i]);
        }
      }    	
      return filteredArray.join("&amp;");
    };
    
    return SearchViewModel;
    
  });
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-ccKoErrorWrapper.html">ccKoErrorWrapper</a></li><li><a href="module-ccKoExtensions.html">ccKoExtensions</a></li></ul><h3>Classes</h3><ul><li><a href="Address.html">Address</a></li><li><a href="CartViewModel.html">CartViewModel</a></li><li><a href="CCStoreConfiguration.html">CCStoreConfiguration</a></li><li><a href="CheckoutScheduledOrder.html">CheckoutScheduledOrder</a></li><li><a href="delegatedAdminContacts.html">delegatedAdminContacts</a></li><li><a href="DynamicProperty.html">DynamicProperty</a></li><li><a href="DynamicPropertyMetaContainer.html">DynamicPropertyMetaContainer</a></li><li><a href="EventDispatcher.html">EventDispatcher</a></li><li><a href="GiftCardViewModel.html">GiftCardViewModel</a></li><li><a href="GiftProductListingViewModel.html">GiftProductListingViewModel</a></li><li><a href="global.html#InfinityViewModel">InfinityViewModel</a></li><li><a href="IntegrationViewModel.html">IntegrationViewModel</a></li><li><a href="ko.bindingHandlers.background.html">background</a></li><li><a href="ko.bindingHandlers.carouselSwipe.html">carouselSwipe</a></li><li><a href="ko.bindingHandlers.ccDateTime.html">ccDateTime</a></li><li><a href="ko.bindingHandlers.ccForm.html">ccForm</a></li><li><a href="ko.bindingHandlers.ccLink.html">ccLink</a></li><li><a href="ko.bindingHandlers.ccValidation.html">ccValidation</a></li><li><a href="ko.bindingHandlers.checkbox.html">checkbox</a></li><li><a href="ko.bindingHandlers.chosen.html">chosen</a></li><li><a href="ko.bindingHandlers.contextResourcesNamespace.html">contextResourcesNamespace</a></li><li><a href="ko.bindingHandlers.currency.html">currency</a></li><li><a href="ko.bindingHandlers.datepicker.html">datepicker</a></li><li><a href="ko.bindingHandlers.datepopover.html">datepopover</a></li><li><a href="ko.bindingHandlers.draggable.html">draggable</a></li><li><a href="ko.bindingHandlers.droppable.html">droppable</a></li><li><a href="ko.bindingHandlers.fade.html">fade</a></li><li><a href="ko.bindingHandlers.hover.html">hover</a></li><li><a href="ko.bindingHandlers.image.html">image</a></li><li><a href="ko.bindingHandlers.imageSource.html">imageSource</a></li><li><a href="ko.bindingHandlers.imageZoom.html">imageZoom</a></li><li><a href="ko.bindingHandlers.localeText.html">localeText</a></li><li><a href="ko.bindingHandlers.makeAccess.html">makeAccess</a></li><li><a href="ko.bindingHandlers.modal.html">modal</a></li><li><a href="ko.bindingHandlers.modalTabbingContraint.html">modalTabbingContraint</a></li><li><a href="ko.bindingHandlers.onRender.html">onRender</a></li><li><a href="ko.bindingHandlers.popeditor.html">popeditor</a></li><li><a href="ko.bindingHandlers.popover.html">popover</a></li><li><a href="ko.bindingHandlers.productImageSource.html">productImageSource</a></li><li><a href="ko.bindingHandlers.productVariantImageSource.html">productVariantImageSource</a></li><li><a href="ko.bindingHandlers.propertyEditor.html">propertyEditor</a></li><li><a href="ko.bindingHandlers.radio.html">radio</a></li><li><a href="ko.bindingHandlers.richTextEditor.html">richTextEditor</a></li><li><a href="ko.bindingHandlers.scrollAffix.html">scrollAffix</a></li><li><a href="ko.bindingHandlers.select2.html">select2</a></li><li><a href="ko.bindingHandlers.select2Tags.html">select2Tags</a></li><li><a href="ko.bindingHandlers.selectable.html">selectable</a></li><li><a href="ko.bindingHandlers.slide.html">slide</a></li><li><a href="ko.bindingHandlers.slider.html">slider</a></li><li><a href="ko.bindingHandlers.spectrum.html">spectrum</a></li><li><a href="ko.bindingHandlers.textCheck.html">textCheck</a></li><li><a href="ko.bindingHandlers.timepicker.html">timepicker</a></li><li><a href="ko.bindingHandlers.triggerMessage.html">triggerMessage</a></li><li><a href="ko.bindingHandlers.validatableTarget.html">validatableTarget</a></li><li><a href="ko.bindingHandlers.validatableValue.html">validatableValue</a></li><li><a href="ko.bindingHandlers.widgetLocaleText.html">widgetLocaleText</a></li><li><a href="koValidation.alphaNumeric.html">alphaNumeric</a></li><li><a href="koValidation.alphaNumericNoSpaces.html">alphaNumericNoSpaces</a></li><li><a href="koValidation.alphaNumericNoSpacesNoDashesWithSeperators.html">alphaNumericNoSpacesNoDashesWithSeperators</a></li><li><a href="koValidation.alphaNumericNoSpacesWithSeperators.html">alphaNumericNoSpacesWithSeperators</a></li><li><a href="koValidation.alphaNumericWithSeperators.html">alphaNumericWithSeperators</a></li><li><a href="koValidation.bool.html">bool</a></li><li><a href="koValidation.creditcard.html">creditcard</a></li><li><a href="koValidation.cvv.html">cvv</a></li><li><a href="koValidation.endmonth.html">endmonth</a></li><li><a href="koValidation.endyear.html">endyear</a></li><li><a href="koValidation.importFileName.html">importFileName</a></li><li><a href="koValidation.laterDate.html">laterDate</a></li><li><a href="koValidation.match.html">match</a></li><li><a href="koValidation.mediaZipFileName.html">mediaZipFileName</a></li><li><a href="koValidation.number.html">number</a></li><li><a href="koValidation.observablePattern.html">observablePattern</a></li><li><a href="koValidation.password.html">password</a></li><li><a href="koValidation.price.html">price</a></li><li><a href="koValidation.propertyIdAlreadyInUse.html">propertyIdAlreadyInUse</a></li><li><a href="koValidation.propertyNameAlreadyInUse.html">propertyNameAlreadyInUse</a></li><li><a href="koValidation.restrictSlashCharacters.html">restrictSlashCharacters</a></li><li><a href="koValidation.startmonth.html">startmonth</a></li><li><a href="koValidation.startyear.html">startyear</a></li><li><a href="koValidation.uniqueTrimmed.html">uniqueTrimmed</a></li><li><a href="koValidation.uniqueTrimmedCaseInsensitive.html">uniqueTrimmedCaseInsensitive</a></li><li><a href="koValidation.url.html">url</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.addTemplate.html">addTemplate</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.agentBar.html">agentBar</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.ccDate.html">ccDate</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.ccNumber.html">ccNumber</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.ccResizeImage.html">ccResizeImage</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.disabled.html">disabled</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.element.html">element</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.embeddedAssistance.html">embeddedAssistance</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.fireChange.html">fireChange</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.inTabFlow.html">inTabFlow</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.noIndexMeta.html">noIndexMeta</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.previewBar.html">previewBar</a></li><li><a href="module-ccKoExtensions-ko.bindingHandlers.setContextVariable.html">setContextVariable</a></li><li><a href="multiCartViewModel.html">multiCartViewModel</a></li><li><a href="NavStateViewModel.html">NavStateViewModel</a></li><li><a href="OrderDetailsViewModel.html">OrderDetailsViewModel</a></li><li><a href="OrderHistoryViewModel.html">OrderHistoryViewModel</a></li><li><a href="OrdersPendingApprovalViewModel.html">OrdersPendingApprovalViewModel</a></li><li><a href="OrderViewModel.html">OrderViewModel</a></li><li><a href="Organization.html">Organization</a></li><li><a href="ParentOrganisation.html">ParentOrganisation</a></li><li><a href="ProductListingSearchViewModel.html">ProductListingSearchViewModel</a></li><li><a href="ProductListingViewModel.html">ProductListingViewModel</a></li><li><a href="ProductTypes.html">ProductTypes</a></li><li><a href="ProductViewModel.html">ProductViewModel</a></li><li><a href="PromotionUpsellContainer.html">PromotionUpsellContainer</a></li><li><a href="PubSub.topicNames.html">topicNames</a></li><li><a href="PurchaseListListingViewModel.html">PurchaseListListingViewModel</a></li><li><a href="PurchaseListViewModel.html">PurchaseListViewModel</a></li><li><a href="RegistrationRequestSearchViewModel.html">RegistrationRequestSearchViewModel</a></li><li><a href="resetCVV.html">resetCVV</a></li><li><a href="resetGiftCardPin.html">resetGiftCardPin</a></li><li><a href="resetPaymentDetails.html">resetPaymentDetails</a></li><li><a href="ReturnItem.html">ReturnItem</a></li><li><a href="ReturnViewModel.html">ReturnViewModel</a></li><li><a href="scheduledOrderList.html">scheduledOrderList</a></li><li><a href="SearchRestClient.html">SearchRestClient</a></li><li><a href="ServerData.html">ServerData</a></li><li><a href="UserViewModel.html">UserViewModel</a></li><li><a href="WidgetViewModel.html">WidgetViewModel</a></li><li><a href="WishlistContentViewModel.html">WishlistContentViewModel</a></li></ul><h3>Namespaces</h3><ul><li><a href="ko.bindingHandlers.html">bindingHandlers</a></li><li><a href="ko.extenders.html">extenders</a></li><li><a href="koValidation.html">koValidation</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addItemToPurchaseList">addItemToPurchaseList</a></li><li><a href="global.html#callWidgetMethodIfApplicable">callWidgetMethodIfApplicable</a></li><li><a href="global.html#CartViewModel#deleteParticularIncompleteOrdersDeletesanincompleteorderbyorderId">CartViewModel#deleteParticularIncompleteOrdersDeletes an incomplete order by orderId</a></li><li><a href="global.html#CCEETagProcessor">CCEETagProcessor</a></li><li><a href="global.html#doesSiteExist">doesSiteExist</a></li><li><a href="global.html#fetchSkuDetailsListError">fetchSkuDetailsListError</a></li><li><a href="global.html#fetchSkuDetailsListSuccess">fetchSkuDetailsListSuccess</a></li><li><a href="global.html#formatSiteText">formatSiteText</a></li><li><a href="global.html#handleInitiateEditSuccess">handleInitiateEditSuccess</a></li><li><a href="global.html#isModified">isModified</a></li><li><a href="global.html#isValidDeterminewhetherornotthepaymentdetailsobjectisvalidbasedonthevalidityofitscomponentparts.Thiswillnotcauseerrormessagestobedisplayedforanyobservablevaluesthatareunchangedandhaveneverreceivedfocusontherelatedformfield(s).">isValidDetermine whether or not the payment details object is validbased on the validity of its component parts. This will notcause error messages to be displayed for any observable valuesthat are unchanged and have never received focus on the related form field(s).</a></li><li><a href="global.html#justFocused">justFocused</a></li><li><a href="global.html#mapProperties">mapProperties</a></li><li><a href="global.html#MENU_CLOSE_TIMEOUT">MENU_CLOSE_TIMEOUT</a></li><li><a href="global.html#populateData">populateData</a></li><li><a href="global.html#populateProductData">populateProductData</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#resetModified">resetModified</a></li><li><a href="global.html#Resetsstylingforthelazilyloadedimage">Resets styling for the lazily loaded image</a></li><li><a href="global.html#Setsupstylingfortheimagetobelazilyloaded">Sets up styling for the image to be lazily loaded</a></li><li><a href="global.html#ShopperContextViewModel">ShopperContextViewModel</a></li><li><a href="global.html#thelistofpropertiestoignorewhilecopyingdynamicpropertiestoaddressobject">the list of properties to ignore while copying dynamic properties to address object</a></li><li><a href="global.html#validatePaymentDetailsForceallrelevantmemberobservablestoperformtheirvalidationnow&displaytheerrors(ifany)">validatePaymentDetailsForce all relevant member observables to perform theirvalidation now & display the errors (if any)</a></li><li><a href="global.html#WidgetQueue">WidgetQueue</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0</a> on Wed Feb 26 2020 18:22:24 GMT+0530 (IST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
